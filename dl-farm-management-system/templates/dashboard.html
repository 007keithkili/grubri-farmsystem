{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Farm Reports & Insights{% endblock %}
{% block page_subtitle %}Performance overview - {{ start_date|default('') }}{% if end_date %} - {{ end_date }}{% else %} (last 30 days){% endif %}{% endblock %}

{% block extra_css %}
<style>
/* HERO banner - larger, clearer */
.hero-banner {
  border-radius: 14px;
  overflow: hidden;
  background: linear-gradient(135deg, #06b6d4 0%, #f59e0b 100%);
  color: #042933;
  padding: 44px 44px;
  margin-bottom: 22px;
  box-shadow: 0 16px 44px rgba(4, 41, 58, 0.14);
}
.hero-banner h1 {
  font-weight: 800;
  margin-bottom: 8px;
  color: #021b23;
  font-size: 2.2rem; /* enlarged */
}
.hero-banner p {
  opacity: 0.96;
  max-width: 960px;
  margin-bottom: 0;
  color: rgba(2,27,35,0.92);
  font-size: 1.05rem; /* slightly larger */
}

/* KPI grid - more spacing and larger numerals */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

/* base KPI card */
.kpi {
  border-radius: 14px;
  padding: 20px;
  display: flex;
  gap: 16px;
  align-items: center;
  background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
  box-shadow: 0 10px 30px rgba(2, 6, 23, 0.05);
  transition: transform .12s ease, box-shadow .12s ease;
}
.kpi:hover { transform: translateY(-6px); box-shadow: 0 20px 48px rgba(3,10,28,0.08); }

.kpi .icon {
  min-width: 98px;
  min-height: 98px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  box-shadow: 0 8px 22px rgba(2,6,23,0.04);
}

/* icon color variations */
.kpi .icon.paw { background: linear-gradient(135deg,#7dd3fc,#38bdf8); color:#042433; }
.kpi .icon.profit { background: linear-gradient(135deg,#bbf7d0,#86efac); color:#054a2c; }
.kpi .icon.feed { background: linear-gradient(135deg,#ffd3a5,#ffb27a); color:#5a2d00; }
.kpi .icon.staff { background: linear-gradient(135deg,#dbeafe,#bfdbfe); color:#0f172a; }
.kpi .icon.med { background: linear-gradient(135deg,#fed7e2,#fbcfe8); color:#3b0b17; }

/* meta text larger and bolder where needed */
.kpi .meta small { color:#555; display:block; font-size:0.95rem; }
.kpi .meta .value { font-weight:800; font-size:2.1rem; margin-top:6px; color:#042433; } /* BIG readable numbers */

/* Export panel */
.export-panel {
  background: linear-gradient(90deg, rgba(6,182,212,0.06), rgba(245,158,11,0.04));
  border-radius: 12px;
  padding: 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:18px;
  box-shadow: 0 8px 28px rgba(3, 10, 28, 0.03);
}
.export-left { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.export-right { display:flex; gap:8px; align-items:center; }

/* inputs/buttons a touch larger for readability */
.export-panel input.form-control,
.export-panel .form-select {
  font-size: 0.95rem;
  padding: 8px 10px;
}

/* Chart sizing increased for clarity */
.chart-lg { min-height:380px; height: 420px !important; }       /* larger main chart */
.chart-medium { min-height:220px; height: 250px !important; }   /* task donut */
.chart-sm { min-height:180px; height: 200px !important; }       /* bottom charts */

/* Card header larger */
.card h6 { font-size: 1.05rem; font-weight:700; color:#0b2540; }

/* Task counts enlarged */
.task-count {
  font-weight:800;
  font-size:1.5rem;
  color:#042433;
}

/* Responsive tweaks */
@media (max-width:900px){
  .hero-banner { padding:24px; }
  .kpi { padding:14px; }
  .export-panel { flex-direction:column; align-items:flex-start; gap:10px; }
}
</style>
{% endblock %}

{% block content %}

<!-- HERO: CLEAN banner (larger and clearer) -->
<div class="hero-banner">
  <div class="d-flex justify-content-between align-items-start">
    <div style="max-width:78%;">
      <h1>DL Farm Management System</h1>
      <p>Insights — financials, production, livestock and operations in one place. Clear, accessible KPIs and printable reports.</p>
    </div>
    <div class="text-end" style="min-width:240px;">
      <div style="background:rgba(2,27,35,0.06); padding:14px 16px; border-radius:10px;">
        <small style="color:#0b3137;">Overview period</small>
        <div style="font-weight:800; font-size:1.05rem; color:#042433;">{{ start_date|default('Last 30 days') }}{% if end_date %} — {{ end_date }}{% endif %}</div>
      </div>
    </div>
  </div>
</div>

<!-- EXPORT PANEL (date + report select + export/print buttons) -->
<div class="export-panel">
  <div class="export-left">
    <div>
      <label class="form-label small mb-1">Start</label>
      <input id="startDate" type="date" class="form-control form-control-sm" value="{{ start_date|default('') }}">
    </div>
    <div>
      <label class="form-label small mb-1">End</label>
      <input id="endDate" type="date" class="form-control form-control-sm" value="{{ end_date|default('') }}">
    </div>
    <div>
      <label class="form-label small mb-1">Report</label>
      <select id="reportType" class="form-select form-select-sm">
        <option value="comprehensive">Comprehensive</option>
        <option value="financial">Financial</option>
        <option value="livestock">Livestock</option>
        <option value="production">Production</option>
        <option value="inventory">Inventory</option>
        <option value="staff">Staff</option>
        <option value="custom">Custom</option>
      </select>
    </div>
    <div style="align-self:end;">
      <button id="generateBtn" class="btn btn-primary btn-sm">Apply</button>
    </div>
  </div>

  <div class="export-right">
    <!-- export buttons -->
    <button id="exportCsv" class="btn btn-outline-primary btn-sm">Export CSV</button>
    <button id="exportExcel" class="btn btn-outline-success btn-sm">Export Excel</button>
    <button id="exportPdf" class="btn btn-outline-danger btn-sm">Export PDF</button>

    <!-- print -->
    <button id="printBtn" class="btn btn-outline-secondary btn-sm">Print</button>
  </div>
</div>

<!-- KPI GRID -->
<div class="kpi-grid">
  <div class="kpi">
    <div class="icon paw"><i class="fas fa-paw fa-lg"></i></div>
    <div class="meta">
      <small>Total Animals</small>
      <div class="value">{{ total_animals|default(0) }}</div>
      <small class="text-muted">head</small>
    </div>
  </div>

  <div class="kpi profit">
    <div class="icon profit"><i class="fas fa-chart-line fa-lg"></i></div>
    <div class="meta">
      <small>Net Profit</small>
      <div class="value">Ksh {{ '%.2f' % (net_profit|default(0)) }}</div>
      <small class="text-muted">Period</small>
    </div>
  </div>

  <div class="kpi feed">
    <div class="icon feed"><i class="fas fa-seedling fa-lg"></i></div>
    <div class="meta">
      <small>Feed Consumed</small>
      <div class="value">{{ (feed_series|default([]) | sum) }}</div>
      <small class="text-muted">kg (range)</small>
    </div>
  </div>

  <div class="kpi staff">
    <div class="icon staff"><i class="fas fa-users fa-lg"></i></div>
    <div class="meta">
      <small>Total Staff</small>
      <div class="value">{{ total_staff|default(0) }}</div>
      <small class="text-muted">employees</small>
    </div>
  </div>

  <div class="kpi medical">
    <div class="icon med"><i class="fas fa-notes-medical fa-lg"></i></div>
    <div class="meta">
      <small>Medical Records</small>
      <div class="value">{{ medical_count|default(0) }}</div>
      <small class="text-muted">records</small>
    </div>
  </div>

  <div class="kpi">
    <div class="icon" style="background:linear-gradient(135deg,#e6eefc,#f6f7ff); color:#042433;"><i class="fas fa-user-tie fa-lg"></i></div>
    <div class="meta">
      <small>Staff Management</small>
      <div class="value">{{ total_staff|default(0) }}</div>
      <small class="text-muted">manage staff</small>
    </div>
  </div>
</div>

<!-- Quick Actions / Quick Reports -->
<div class="card p-3 mb-3">
  <h6 class="mb-2">Quick Actions & Reports</h6>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('reports') }}?report_type=financial">Financial Reports</a>
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('reports') }}?report_type=livestock">Livestock Reports</a>
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('reports') }}?report_type=production">Production Reports</a>
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('reports') }}?report_type=inventory">Inventory Reports</a>
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('reports') }}?report_type=staff">Staff Reports</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('reports') }}?report_type=custom">Custom Report</a>
  </div>
</div>

<!-- FINANCIAL TREND: large -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0">Financial Trend</h6>
    <small class="text-muted">Period: {{ start_date|default('') }} — {{ end_date|default('') }}</small>
  </div>
  <canvas id="chartFinancial" class="chart-lg"></canvas>
</div>

<!-- TASK STATUS (below Financial) -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0">Task Status</h6>
    <small class="text-muted">Overview</small>
  </div>
  <div class="row align-items-center">
    <div class="col-md-6">
      <canvas id="chartTasks" class="chart-medium"></canvas>
    </div>
    <div class="col-md-6">
      <div>
        <div class="small text-muted">Pending</div>
        <div class="task-count">{{ task_counts.Pending|default(0) }}</div>
      </div>
      <div class="mt-3">
        <div class="small text-muted">In Progress</div>
        <div class="task-count">{{ task_counts['In Progress']|default(0) }}</div>
      </div>
      <div class="mt-3">
        <div class="small text-muted">Completed</div>
        <div class="task-count">{{ task_counts.Completed|default(0) }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom charts: Feed and Avg weight -->
<div class="row g-3 mt-3">
  <div class="col-md-6">
    <div class="card p-3">
      <h6 style="font-size:1.05rem;">Daily Feed Consumption</h6>
      <canvas id="chartFeed" class="chart-sm"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card p-3">
      <h6 style="font-size:1.05rem;">Average Weight Trend</h6>
      <canvas id="chartWeight" class="chart-sm"></canvas>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Provide safe defaults so template never throws in JS
  const days = {{ days|default([])|tojson }};
  const income = {{ income_series|default([])|tojson }};
  const expense = {{ expense_series|default([])|tojson }};
  const feed = {{ feed_series|default([])|tojson }};
  const avgWeight = {{ avg_weight_series|default([])|tojson }};
  const taskCounts = {{ task_counts|default({'Pending':0,'In Progress':0,'Completed':0})|tojson }};

  // Financial trend
  const finCtx = document.getElementById('chartFinancial');
  if (finCtx) {
    window.finChart = new Chart(finCtx, {
      type: 'line',
      data: {
        labels: days,
        datasets: [
          { label: 'Income', data: income, borderColor:'#16a34a', backgroundColor:'rgba(16,163,127,0.10)', fill:true, tension:0.25, pointRadius:3 },
          { label: 'Expense', data: expense, borderColor:'#dc2626', backgroundColor:'rgba(220,38,38,0.06)', fill:true, tension:0.25, pointRadius:3 }
        ]
      },
      options: { plugins:{legend:{position:'bottom'}}, scales:{ y:{beginAtZero:true} } }
    });
  }

  // Task donut
  const tCtx = document.getElementById('chartTasks');
  if (tCtx) {
    new Chart(tCtx, {
      type: 'doughnut',
      data: {
        labels: ['Pending','In Progress','Completed'],
        datasets: [{
          data: [taskCounts.Pending||0, taskCounts['In Progress']||0, taskCounts.Completed||0],
          backgroundColor: ['#f59e0b','#3b82f6','#10b981']
        }]
      },
      options: { plugins:{legend:{position:'bottom'}} }
    });
  }

  // Feed bar
  const fCtx = document.getElementById('chartFeed');
  if (fCtx) {
    window.feedChart = new Chart(fCtx, {
      type: 'bar',
      data: { labels: days, datasets: [{ label:'Feed (kg)', data: feed, backgroundColor:'#f97316' }] },
      options: { scales:{ y:{ beginAtZero:true } } }
    });
  }

  // Average weight line
  const wCtx = document.getElementById('chartWeight');
  if (wCtx) {
    window.weightChart = new Chart(wCtx, {
      type: 'line',
      data: { labels: days, datasets: [{ label:'Avg weight (kg)', data: avgWeight, borderColor:'#7c3aed', backgroundColor:'rgba(124,58,237,0.06)', fill:true }] },
      options: { scales:{ y:{ beginAtZero:true } } }
    });
  }

  // Export POST helper to /generate-report
  function postReport(format){
    const start = document.getElementById('startDate')?.value || '';
    const end = document.getElementById('endDate')?.value || '';
    const type = document.getElementById('reportType')?.value || 'comprehensive';
    const form = document.createElement('form');
    form.method = 'POST'; form.action = '{{ url_for("generate_report") }}'; form.style.display='none';
    [['start_date',start],['end_date',end],['report_type',type],['format',format]].forEach(([n,v]) => {
      const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i);
    });
    document.body.appendChild(form); form.submit();
  }
  document.getElementById('exportCsv')?.addEventListener('click', ()=>postReport('csv'));
  document.getElementById('exportExcel')?.addEventListener('click', ()=>postReport('excel'));
  document.getElementById('exportPdf')?.addEventListener('click', ()=>postReport('pdf'));
  document.getElementById('printBtn')?.addEventListener('click', ()=> window.print());

  // Generate (apply) button: reload page with ?start=&end= so server can re-render with filtered data
  document.getElementById('generateBtn')?.addEventListener('click', function(){
    const s = document.getElementById('startDate')?.value;
    const e = document.getElementById('endDate')?.value;
    const p = new URLSearchParams();
    if (s) p.set('start', s);
    if (e) p.set('end', e);
    const url = window.location.pathname + (p.toString() ? ('?' + p.toString()) : '');
    window.location.href = url;
  });
})();
</script>
{% endblock %}
