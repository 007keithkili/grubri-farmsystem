{% extends "base.html" %}
{% block title %}Task Management{% endblock %}
{% block page_title %}Task Management{% endblock %}
{% block page_subtitle %}Track and assign farm tasks{% endblock %}

{% block extra_css %}
<style>
/* Small layout polish for task page */
.content-card { padding: 18px; background: #fff; border-radius: 12px; box-shadow: 0 8px 20px rgba(2,6,23,0.04); }
.stat-card { background: linear-gradient(180deg,#fff,#fbfdff); padding: 14px; border-radius: 10px; box-shadow: 0 6px 14px rgba(2,6,23,0.03); text-align:center; }
.stat-card i { font-size:22px; display:block; margin-bottom:6px; }
.controls-row { display:flex; gap:8px; align-items:center; }
#viewControls { display:flex; gap:8px; align-items:center; }
#chartsArea { display:none; margin-top:14px; }
.chart-card { background:#fff; padding:12px; border-radius:10px; box-shadow:0 8px 18px rgba(2,6,23,0.04); }
.small-muted { color:#6b7280; font-size:0.88rem; }

/* keep table and charts responsive */
#chartsRow { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
@media (max-width:900px){ #chartsRow { grid-template-columns:1fr; } }

/* hide non-print UI when printing, show just the printable area */
@media print {
  body * { visibility: hidden !important; }
  #printArea, #printArea * { visibility: visible !important; }
  #printArea { position: absolute; left: 0; top: 0; width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<div class="content-card">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 style="margin:0;">Task Management</h4>
      <div class="small-muted">Track, assign and manage farm tasks</div>
    </div>

    <div id="viewControls" class="controls-row">
      <button id="toggleViewBtn" class="btn btn-outline-secondary btn-sm" title="Toggle charts / table">
        <i class="fas fa-chart-bar"></i> Toggle View
      </button>

      <button id="printBtn" class="btn btn-outline-primary btn-sm" title="Print visible">
        <i class="fas fa-print"></i> Print
      </button>

      <button id="exportCsvBtn" class="btn btn-outline-success btn-sm" title="Export CSV">
        <i class="fas fa-file-csv"></i> CSV
      </button>

      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
        <i class="fas fa-plus"></i> Create Task
      </button>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #e74c3c;">
        <i class="fas fa-exclamation-circle"></i>
        <h3>{{ pending_count|default(0) }}</h3>
        <p>Pending Tasks</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #f39c12;">
        <i class="fas fa-clock"></i>
        <h3>{{ inprogress_count|default(0) }}</h3>
        <p>In Progress</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #2ecc71;">
        <i class="fas fa-check-circle"></i>
        <h3>{{ completed_count|default(0) }}</h3>
        <p>Completed</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #3498db;">
        <i class="fas fa-calendar-day"></i>
        <h3>{{ overdue_count|default(0) }}</h3>
        <p>Overdue</p>
      </div>
    </div>
  </div>

  <!-- PRINTABLE AREA (charts + table inside for focused printing) -->
  <div id="printArea">
    <!-- Charts (initially hidden; toggled by button) -->
    <div id="chartsArea" class="mb-3">
      <div id="chartsRow">
        <div class="chart-card">
          <h6 style="margin:0 0 10px 0;">Tasks by Status</h6>
          <canvas id="statusDonut" style="height:220px;"></canvas>
        </div>

        <div class="chart-card">
          <h6 style="margin:0 0 10px 0;">Priorities</h6>
          <canvas id="priorityBar" style="height:220px;"></canvas>
        </div>

        <div class="chart-card" style="grid-column: 1 / -1;">
          <h6 style="margin:0 0 10px 0;">Top Categories</h6>
          <canvas id="categoryBar" style="height:240px;"></canvas>
        </div>
      </div>
    </div>

    <!-- Table (default visible) -->
    <div class="table-responsive mb-2" id="tableArea">
      <!-- DataTables picks up .data-table from base.html -->
      <table class="table table-hover data-table" id="tasksTable">
        <thead class="table-dark">
          <tr>
            <th>Task ID</th>
            <th>Title</th>
            <th>Assigned To</th>
            <th>Due Date</th>
            <th>Priority</th>
            <th>Category</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tfoot class="table-dark">
          <tr>
            <th>Task ID</th>
            <th>Title</th>
            <th>Assigned To</th>
            <th>Due Date</th>
            <th>Priority</th>
            <th>Category</th>
            <th>Actions</th>
          </tr>
        </tfoot>

        <tbody>
          {% if tasks %}
            {% for t in tasks %}
            <tr data-task-id="{{ t.id }}">
              <td>T-{{ t.id }}</td>

              <!-- Title cell (title + small description) -->
              <td style="min-width:220px;">
                <div style="font-weight:600;">{{ t.title }}</div>
                {% if t.description %}
                  <div class="text-muted small">{{ t.description }}</div>
                {% endif %}
              </td>

              <!-- Assigned To: robust lookup that handles missing staff_map and key-type mismatches -->
              <td>
                {% set assigned_display = None %}
                {% if staff_map is defined %}
                  {% if t.assigned_to is not none %}
                    {% set assigned_display = staff_map.get(t.assigned_to) %}
                  {% endif %}
                  {% if not assigned_display and t.assigned_to is not none %}
                    {% set assigned_display = staff_map.get((t.assigned_to ~ '')) %}
                  {% endif %}
                {% endif %}
                {% if assigned_display %}
                  {{ assigned_display }}
                {% else %}
                  {{ t.assigned_to or 'Unassigned' }}
                {% endif %}
              </td>

              <!-- Due date -->
              <td>{{ t.due_date or 'â€”' }}</td>

              <!-- Priority with badge -->
              <td>
                {% set p = (t.priority or 'Normal') %}
                {% if p == 'High' %}
                  <span class="badge bg-danger">{{ p }}</span>
                {% elif p == 'Normal' %}
                  <span class="badge bg-info">{{ p }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ p }}</span>
                {% endif %}
              </td>

              <!-- Category -->
              <td>{{ t.category or 'general' }}</td>

              <!-- Actions: view / edit / delete + status buttons -->
              <td>
                <div style="display:flex; gap:6px; align-items:center;">
                  <a href="/tasks/{{ t.id }}" class="btn btn-sm btn-info" title="View"><i class="fas fa-eye"></i></a>
                  <a href="/tasks/{{ t.id }}/edit" class="btn btn-sm btn-warning" title="Edit"><i class="fas fa-edit"></i></a>

                  <button class="btn btn-sm btn-danger" title="Delete" onclick="deleteTask({{ t.id }}, this)"><i class="fas fa-trash"></i></button>

                  {% if t.status != 'In Progress' %}
                    <button class="btn btn-sm btn-success" title="Mark In Progress"
                            onclick="updateTaskStatus({{ t.id }}, 'In Progress')"><i class="fas fa-play"></i></button>
                  {% else %}
                    <button class="btn btn-sm btn-outline-success" disabled title="Already In Progress"><i class="fas fa-play"></i></button>
                  {% endif %}

                  {% if t.status != 'Completed' %}
                    <button class="btn btn-sm btn-primary" title="Mark Completed"
                            onclick="updateTaskStatus({{ t.id }}, 'Completed')"><i class="fas fa-check"></i></button>
                  {% else %}
                    <button class="btn btn-sm btn-outline-primary" disabled title="Already Completed"><i class="fas fa-check"></i></button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center">No tasks found.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div> <!-- end printArea -->
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Use literal action path to match your route -->
      <form method="POST" action="/add_task">
        <div class="modal-header">
          <h5 class="modal-title">Create New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">Title *</label>
              <input type="text" name="title" class="form-control" required>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Assigned To</label>
              <select name="assigned_to" class="form-select">
                <option value="">-- Unassigned --</option>
                {% for s in staff_members %}
                  <option value="{{ s.id }}">{{ s.first_name }} {{ s.last_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Due Date</label>
              <input type="date" name="due_date" class="form-control">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Priority</label>
              <select name="priority" class="form-select">
                <option value="Normal" selected>Normal</option>
                <option value="High">High</option>
                <option value="Low">Low</option>
              </select>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Category</label>
              <input type="text" name="category" class="form-control" placeholder="e.g. maintenance, feeding">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Provide tasks data to JS
const tasksData = {{ tasks|default([])|tojson }};

function ensureChartJs(cb){
  if (typeof Chart !== 'undefined') return cb();
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
  s.onload = cb;
  document.head.appendChild(s);
}

/* ---------- Chart initialization ---------- */
function initCharts(){
  // status counts (we also have server counts in variables, but derive from tasks for consistency)
  const statusCounts = { Pending:0, 'In Progress':0, Completed:0, Overdue:0 };
  const priorityCounts = { High:0, Normal:0, Low:0 };
  const categoryCounts = {};

  tasksData.forEach(t => {
    const st = t.status || 'Pending';
    statusCounts[st] = (statusCounts[st]||0) + 1;
    // Overdue detection: if due_date exists and < today (basic compare)
    if (t.due_date) {
      try {
        const d = new Date(t.due_date);
        const now = new Date();
        if (!isNaN(d) && d < new Date(now.getFullYear(), now.getMonth(), now.getDate())) {
          statusCounts.Overdue = (statusCounts.Overdue||0) + 1;
        }
      } catch(e){}
    }
    const pr = (t.priority || 'Normal');
    priorityCounts[pr] = (priorityCounts[pr]||0) + 1;

    const cat = (t.category || 'general');
    categoryCounts[cat] = (categoryCounts[cat]||0) + 1;
  });

  // Status donut
  const ctxStatus = document.getElementById('statusDonut');
  if (ctxStatus) {
    new Chart(ctxStatus, {
      type: 'doughnut',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{ data: Object.values(statusCounts) }]
      },
      options: { plugins:{ legend:{ position:'bottom' } }, cutout: '60%' }
    });
  }

  // Priority bar
  const ctxPri = document.getElementById('priorityBar');
  if (ctxPri) {
    new Chart(ctxPri, {
      type: 'bar',
      data: { labels: Object.keys(priorityCounts), datasets: [{ label:'Tasks', data: Object.values(priorityCounts) }] },
      options: { plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // Categories (top 8)
  const cats = Object.entries(categoryCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const labels = cats.map(c=>c[0]);
  const vals = cats.map(c=>c[1]);
  const ctxCat = document.getElementById('categoryBar');
  if (ctxCat) {
    new Chart(ctxCat, {
      type: 'bar',
      data: { labels: labels, datasets: [{ label:'Count', data: vals }] },
      options: { plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } }, indexAxis: 'x' }
    });
  }
}

/* ---------- Toggle view / Print / Export ---------- */
document.addEventListener('DOMContentLoaded', function(){
  const toggleBtn = document.getElementById('toggleViewBtn');
  const chartsArea = document.getElementById('chartsArea');
  const tableArea = document.getElementById('tableArea');

  toggleBtn?.addEventListener('click', function(){
    if (chartsArea.style.display === 'none' || chartsArea.style.display === '') {
      chartsArea.style.display = 'block';
      tableArea.style.display = 'none';
      ensureChartJs(initCharts);
      toggleBtn.innerHTML = '<i class="fas fa-table"></i> Table View';
    } else {
      chartsArea.style.display = 'none';
      tableArea.style.display = 'block';
      toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Toggle View';
    }
  });

  document.getElementById('printBtn')?.addEventListener('click', function(){
    window.print();
  });

  document.getElementById('exportCsvBtn')?.addEventListener('click', function(){
    // Simple CSV export of current table rows
    const rows = Array.from(document.querySelectorAll('#tasksTable tbody tr'));
    const csv = [];
    rows.forEach(r => {
      const cols = Array.from(r.querySelectorAll('td')).map(td => '"' + td.innerText.replace(/"/g,'""') + '"');
      if (cols.length) csv.push(cols.join(','));
    });
    if (!csv.length) return alert('No rows to export');
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'tasks_export.csv'; a.style.display='none';
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  });

  // Make sure charts are available if user toggles immediately and Chart.js not yet loaded
  if (typeof Chart === 'undefined') {
    // don't automatically init charts until user toggles (keeps page light)
  } else {
    // Chart.js already loaded by base - nothing to do
  }
});

/* ---------- Delete task (POST form-style so server accepts it reliably) ---------- */
function deleteTask(taskId, btnEl){
  if (!taskId) return;
  if (!confirm('Delete task #' + taskId + '? This cannot be undone.')) return;
  // send as form-like body (application/x-www-form-urlencoded)
  const body = new URLSearchParams(); body.append('task_id', taskId);
  fetch('/delete_task', { method: 'POST', body: body })
    .then(r => r.json ? r.json() : r.text().then(t=>({success:false,message:t})))
    .then(j => {
      if (j && j.success) {
        // remove row from table for instant feedback
        const tr = btnEl.closest('tr');
        if (tr) tr.remove();
        if (window._dl_showToast) window._dl_showToast(j.message || 'Deleted', 'success');
      } else {
        alert(j && j.message ? j.message : 'Delete failed');
      }
    }).catch(e => { console.error(e); alert('Network/Server error'); });
}

/* ---------- Reuse updateTaskStatus from your template but using literal path ---------- */
function updateTaskStatus(taskId, status) {
    if (!taskId) return;
    if (!confirm('Update task status to "' + status + '"?')) return;
    fetch('/update_task_status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({task_id: taskId, status: status})
    })
    .then(r => r.json())
    .then(j => {
        if (j && j.success) {
            if (window._dl_showToast) window._dl_showToast(j.message || 'Updated', 'success');
            setTimeout(() => location.reload(), 600);
        } else {
            alert(j.message || 'Error updating status');
        }
    })
    .catch(e => { console.error(e); alert('Network error'); });
}
</script>
{% endblock %}
