{% extends "base.html" %}
{% block title %}Task Management{% endblock %}
{% block page_title %}Task Management{% endblock %}
{% block page_subtitle %}Track and assign farm tasks{% endblock %}

{% block content %}
<div class="content-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Task Management</h4>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
      <i class="fas fa-plus"></i> Create Task
    </button>
  </div>

  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #e74c3c;">
        <i class="fas fa-exclamation-circle"></i>
        <h3>{{ pending_count|default(0) }}</h3>
        <p>Pending Tasks</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #f39c12;">
        <i class="fas fa-clock"></i>
        <h3>{{ inprogress_count|default(0) }}</h3>
        <p>In Progress</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #2ecc71;">
        <i class="fas fa-check-circle"></i>
        <h3>{{ completed_count|default(0) }}</h3>
        <p>Completed</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="border-top-color: #3498db;">
        <i class="fas fa-calendar-day"></i>
        <h3>{{ overdue_count|default(0) }}</h3>
        <p>Overdue</p>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <!-- DataTables picks up .data-table from base.html -->
    <table class="table table-hover data-table" id="tasksTable">
      <thead class="table-dark">
        <tr>
          <th>Task ID</th>
          <th>Title</th>
          <th>Assigned To</th>
          <th>Due Date</th>
          <th>Priority</th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tfoot class="table-dark">
        <tr>
          <th>Task ID</th>
          <th>Title</th>
          <th>Assigned To</th>
          <th>Due Date</th>
          <th>Priority</th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
      </tfoot>

      <tbody>
        {% if tasks %}
          {% for t in tasks %}
          <tr>
            <td>T-{{ t.id }}</td>

            <!-- Title cell (title + small description) -->
            <td>
              <div style="font-weight:600;">{{ t.title }}</div>
              {% if t.description %}
                <div class="text-muted small">{{ t.description }}</div>
              {% endif %}
            </td>

            <!-- Assigned To: use staff_map if assigned_to is an id that exists in the map -->
            <td>
              {% set assigned_key = t.assigned_to|string %}
              {% if assigned_key and (assigned_key in staff_map) %}
                {{ staff_map[assigned_key] }}
              {% else %}
                {{ t.assigned_to or 'Unassigned' }}
              {% endif %}
            </td>

            <!-- Due date -->
            <td>{{ t.due_date or 'â€”' }}</td>

            <!-- Priority with badge (always show a cell) -->
            <td>
              {% set p = (t.priority or 'Normal') %}
              {% if p == 'High' %}
                <span class="badge bg-danger">{{ p }}</span>
              {% elif p == 'Normal' %}
                <span class="badge bg-info">{{ p }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ p }}</span>
              {% endif %}
            </td>

            <!-- Category -->
            <td>{{ t.category or 'general' }}</td>

            <!-- Actions: view / edit (links) + status buttons (data-action used by base JS) -->
            <td>
              <a href="{{ url_for('view_task', task_id=t.id) }}" class="btn btn-sm btn-info" title="View">
                <i class="fas fa-eye"></i>
              </a>

              <a href="{{ url_for('edit_task', task_id=t.id) }}" class="btn btn-sm btn-warning" title="Edit">
                <i class="fas fa-edit"></i>
              </a>

              {% if t.status != 'In Progress' %}
              <button class="btn btn-sm btn-success" title="Mark In Progress"
                      data-action="update-status"
                      data-task-id="{{ t.id }}"
                      data-status="In Progress"
                      onclick="updateTaskStatus({{ t.id }}, 'In Progress')">
                <i class="fas fa-play"></i>
              </button>
              {% else %}
              <button class="btn btn-sm btn-outline-success" disabled title="Already In Progress">
                <i class="fas fa-play"></i>
              </button>
              {% endif %}

              {% if t.status != 'Completed' %}
              <button class="btn btn-sm btn-primary" title="Mark Completed"
                      data-action="update-status"
                      data-task-id="{{ t.id }}"
                      data-status="Completed"
                      onclick="updateTaskStatus({{ t.id }}, 'Completed')">
                <i class="fas fa-check"></i>
              </button>
              {% else %}
              <button class="btn btn-sm btn-outline-primary" disabled title="Already Completed">
                <i class="fas fa-check"></i>
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center">No tasks found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('add_task') }}">
        <div class="modal-header">
          <h5 class="modal-title">Create New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">Title *</label>
              <input type="text" name="title" class="form-control" required>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Assigned To</label>
              <select name="assigned_to" class="form-select">
                <option value="">-- Unassigned --</option>
                {% for s in staff_members %}
                  <option value="{{ s.id }}">{{ s.first_name }} {{ s.last_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Due Date</label>
              <input type="date" name="due_date" class="form-control">
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Priority</label>
              <select name="priority" class="form-select">
                <option value="Normal" selected>Normal</option>
                <option value="High">High</option>
                <option value="Low">Low</option>
              </select>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Category</label>
              <input type="text" name="category" class="form-control" placeholder="e.g. maintenance, feeding">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Fallback JS for updating status -->
<script>
function updateTaskStatus(taskId, status) {
    if (!taskId) return;
    if (!confirm('Update task status to "' + status + '"?')) return;
    fetch('{{ url_for("update_task_status") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({task_id: taskId, status: status})
    })
    .then(r => r.json())
    .then(j => {
        if (j && j.success) {
            if (window._dl_showToast) window._dl_showToast(j.message || 'Updated', 'success');
            setTimeout(() => location.reload(), 600);
        } else {
            alert(j.message || 'Error updating status');
        }
    })
    .catch(e => { console.error(e); alert('Network error'); });
}
</script>
{% endblock %}
