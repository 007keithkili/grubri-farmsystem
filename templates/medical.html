{% extends "base.html" %}
{% block title %}Medical Records{% endblock %}
{% block page_title %}Medical Records{% endblock %}
{% block page_subtitle %}Animal treatments and checkups{% endblock %}

{% block content %}
<!-- Welcome & Purpose Section -->
<div class="content-card mb-4">
  <div class="row align-items-center">
    <div class="col-md-8">
      <h4 class="mb-3"><i class="fas fa-stethoscope text-primary me-2"></i>Animal Medical Records System</h4>
      <p class="text-muted mb-3">
        This page manages all animal medical treatments, checkups, and health records. 
        Track animal conditions, treatments provided, veterinarian information, and schedule follow-up appointments.
      </p>
      <div class="d-flex flex-wrap gap-2">
        <span class="badge bg-info bg-opacity-10 text-info border border-info">
          <i class="fas fa-paw me-1"></i>Animal Health Tracking
        </span>
        <span class="badge bg-success bg-opacity-10 text-success border border-success">
          <i class="fas fa-syringe me-1"></i>Treatment Records
        </span>
        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning">
          <i class="fas fa-user-md me-1"></i>Veterinarian Management
        </span>
        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary">
          <i class="fas fa-calendar-check me-1"></i>Follow-up Scheduling
        </span>
      </div>
    </div>
    <div class="col-md-4 text-md-end">
      <div class="card border-primary">
        <div class="card-body text-center">
          <i class="fas fa-info-circle fa-3x text-primary mb-2"></i>
          
          
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addMedicalModal">
            <i class="fas fa-plus me-1"></i>Quick Add
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Summary Stats Cards -->
<div class="row mb-4">
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card bg-primary bg-gradient text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title text-white-50">Total Records</h6>
            <h2 class="mb-0">{{ medical_records|length if medical_records else 0 }}</h2>
          </div>
          <i class="fas fa-clipboard-list fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card bg-success bg-gradient text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title text-white-50">Active Animals</h6>
            <h2 class="mb-0">
              {% if medical_records %}
                {% set animal_ids = [] %}
                {% for record in medical_records %}
                  {% set aid = record.animal_id or '' %}
                  {% if aid and aid not in animal_ids %}
                    {% set _ = animal_ids.append(aid) %}
                  {% endif %}
                {% endfor %}
                {{ animal_ids|length }}
              {% else %}
                0
              {% endif %}
            </h2>
          </div>
          <i class="fas fa-paw fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card bg-warning bg-gradient text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title text-white-50">With Vet Info</h6>
            <h2 class="mb-0">
              {% if medical_records %}
                {% set with_vet = [] %}
                {% for record in medical_records %}
                  {% if record.veterinarian %}
                    {% set _ = with_vet.append(record) %}
                  {% endif %}
                {% endfor %}
                {{ with_vet|length }}
              {% else %}
                0
              {% endif %}
            </h2>
          </div>
          <i class="fas fa-user-md fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card bg-info bg-gradient text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title text-white-50">Unique Conditions</h6>
            <h2 class="mb-0">
              {% if medical_records %}
                {% set conditions = [] %}
                {% for record in medical_records %}
                  {% set cond = record.condition or '' %}
                  {% if cond and cond not in conditions %}
                    {% set _ = conditions.append(cond) %}
                  {% endif %}
                {% endfor %}
                {{ conditions|length }}
              {% else %}
                0
              {% endif %}
            </h2>
          </div>
          <i class="fas fa-heartbeat fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Overview Section -->
<div class="row mb-4">
  <div class="col-md-8">
    <!-- Condition Overview -->
    <div class="content-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fas fa-heartbeat text-danger me-2"></i> Condition Overview</h5>
        <small class="text-muted">Most common conditions</small>
      </div>
      <div class="row">
        {% if medical_records %}
          {% set condition_counts = {} %}
          {% for record in medical_records %}
            {% set condition = record.condition or 'Unknown' %}
            {% if condition in condition_counts %}
              {% set _ = condition_counts.update({condition: condition_counts[condition] + 1}) %}
            {% else %}
              {% set _ = condition_counts.update({condition: 1}) %}
            {% endif %}
          {% endfor %}
          
          {# Convert items to list, sort by count descending, then take first 6 safely #}
          {% for condition, count in (condition_counts.items()|list|sort(attribute='1', reverse=True))[:6] %}
            <div class="col-md-4 col-lg-2 col-sm-6 mb-3">
              <div class="card border-start border-4 
                {% set cl = (condition or '')|lower %}
                {% if 'emergency' in cl or 'critical' in cl %}border-danger
                {% elif 'routine' in cl or 'checkup' in cl %}border-success
                {% else %}border-primary{% endif %} h-100">
                <div class="card-body py-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1 text-truncate" title="{{ condition }}">{{ condition }}</h6>
                      <small class="text-muted">{{ count }} record{% if count > 1 %}s{% endif %}</small>
                    </div>
                    <span class="badge 
                      {% if 'emergency' in cl or 'critical' in cl %}bg-danger
                      {% elif 'routine' in cl or 'checkup' in cl %}bg-success
                      {% else %}bg-primary{% endif %} rounded-pill">
                      {{ ((count / (medical_records|length or 1)) * 100)|int }}%
                    </span>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <div class="text-center py-4">
              <i class="fas fa-heartbeat fa-2x text-muted mb-3"></i>
              <p class="text-muted mb-0">No condition data available</p>
              <small class="text-muted">Add medical records to see condition statistics</small>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <!-- Quick Status Guide -->
    <div class="content-card h-100">
      <h5 class="mb-3"><i class="fas fa-question-circle text-primary me-2"></i> Quick Guide</h5>
      <div class="mb-3">
        <h6 class="text-muted mb-2">Status Colors</h6>
        <div class="d-flex flex-column gap-2">
          <div class="d-flex align-items-center">
            <span class="badge bg-danger me-2" style="width: 20px; height: 20px;"></span>
            <small>Critical/Emergency - Requires immediate attention</small>
          </div>
          <div class="d-flex align-items-center">
            <span class="badge bg-warning me-2" style="width: 20px; height: 20px;"></span>
            <small>Treatment - Ongoing medical treatment</small>
          </div>
          <div class="d-flex align-items-center">
            <span class="badge bg-success me-2" style="width: 20px; height: 20px;"></span>
            <small>Routine - Regular checkups and maintenance</small>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <h6 class="text-muted mb-2">Data Fields Explained</h6>
        <ul class="small text-muted mb-0 ps-3">
          <li><strong>Condition:</strong> Animal's medical issue</li>
          <li><strong>Treatment:</strong> Procedure/medication given</li>
          <li><strong>Vet:</strong> Assigned veterinarian</li>
          <li><strong>Next Checkup:</strong> Follow-up date</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity & Upcoming -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="content-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fas fa-history text-info me-2"></i> Recent Activity</h5>
        <small class="text-muted">Latest 5 records</small>
      </div>
      {% if medical_records %}
        {# Get latest 5 records safely #}
        {% set recent_records = (medical_records|sort(attribute='treatment_date', reverse=True))[:5] %}
        <div class="list-group list-group-flush">
          {% for record in recent_records %}
            <div class="list-group-item border-0 px-0 py-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="d-flex align-items-center mb-1">
                    <i class="fas fa-paw text-primary me-2"></i>
                    <strong>Animal {{ record.animal_id or '' }}</strong>
                    {% set rc = (record.condition or '')|lower %}
                    <span class="badge ms-2 
                      {% if 'emergency' in rc or 'critical' in rc %}bg-danger
                      {% elif 'routine' in rc or 'checkup' in rc %}bg-success
                      {% else %}bg-warning{% endif %}">
                      {{ (record.condition or '')[:15] }}{% if (record.condition or '')|length > 15 %}...{% endif %}
                    </span>
                  </div>
                  <small class="text-muted">{{ record.treatment_date or '' }} • {{ (record.treatment or '')[:30] }}{% if (record.treatment or '')|length > 30 %}...{% endif %}</small>
                </div>
                <small class="text-muted">{{ record.treatment_date or '' }}</small>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-4">
          <i class="fas fa-history fa-2x text-muted mb-3"></i>
          <p class="text-muted mb-0">No recent activity</p>
        </div>
      {% endif %}
    </div>
  </div>
  <div class="col-md-6">
    <div class="content-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fas fa-calendar-alt text-success me-2"></i> Upcoming Checkups</h5>
        <small class="text-muted">Next items with scheduled checkups</small>
      </div>
      {% if medical_records %}
        {% set upcoming = [] %}
        {% for record in medical_records %}
          {% if record.next_checkup %}
            {% set _ = upcoming.append(record) %}
          {% endif %}
        {% endfor %}
        {# Sort upcoming and take first 5 safely #}
        {% set upcoming_sorted = (upcoming|sort(attribute='next_checkup'))[:5] %}
        {% if upcoming_sorted %}
          <div class="list-group list-group-flush">
            {% for record in upcoming_sorted %}
              <div class="list-group-item border-0 px-0 py-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="d-flex align-items-center mb-1">
                      <i class="fas fa-clock text-warning me-2"></i>
                      <strong>Animal {{ record.animal_id or '' }}</strong>
                    </div>
                    <small class="text-muted">{{ (record.condition or '')[:25] }}{% if (record.condition or '')|length > 25 %}...{% endif %}</small>
                  </div>
                  <div class="text-end">
                    <div class="text-success fw-semibold">{{ record.next_checkup }}</div>
                    <small class="text-muted">Follow-up</small>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-4">
            <i class="fas fa-calendar-check fa-2x text-muted mb-3"></i>
            <p class="text-muted mb-0">No upcoming checkups</p>
            <small class="text-muted">Add next checkup dates to see them here</small>
          </div>
        {% endif %}
      {% else %}
        <div class="text-center py-4">
          <i class="fas fa-calendar-check fa-2x text-muted mb-3"></i>
          <p class="text-muted mb-0">No medical records</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Main Records Table -->
<div class="content-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-0">Medical Records Database</h4>
      <p class="text-muted mb-0">Detailed view of all treatments and checkups. Click on any record to view details.</p>
    </div>
    <div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicalModal">
        <i class="fas fa-plus me-2"></i> Add Record
      </button>
      <!-- PRINT BUTTON ADDED -->
      <button id="printMedical" class="btn btn-outline-secondary ms-2">
        <i class="fas fa-print me-1"></i>Print
      </button>
    </div>
  </div>

  <!-- Quick Filters -->
  <div class="row mb-3">
    <div class="col-md-8">
      <div class="d-flex align-items-center">
        <span class="me-3 text-muted small">Filter by:</span>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-secondary active filter-btn" data-filter="all">All</button>
          <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="critical">Critical</button>
          <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="routine">Routine</button>
          <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="with_vet">With Vet</button>
          <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="upcoming">Upcoming</button>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="input-group input-group-sm">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" class="form-control" placeholder="Search records..." id="searchInput">
        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Records Table -->
  <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
    <table class="table table-hover table-striped mb-0">
      <thead class="table-dark sticky-top">
        <tr>
          <th width="80">ID</th>
          <th width="100">Animal ID</th>
          <th width="120">Treatment Date</th>
          <th>Condition</th>
          <th>Treatment</th>
          <th width="120">Vet</th>
          <th width="120">Next Checkup</th>
          <th width="100">Status</th>
          <th width="140">Actions</th>
        </tr>
      </thead>
      <tbody id="recordsTable">
        {% if medical_records %}
          {% for m in medical_records %}
          {% set cond_lower = (m.condition or '')|lower %}
          <tr class="record-row" 
              data-condition="{{ cond_lower }}" 
              data-vet="{{ 'true' if m.veterinarian else 'false' }}"
              data-next-checkup="{{ m.next_checkup if m.next_checkup else '' }}">
            <td>
              <span class="badge bg-secondary">M-{{ m.id }}</span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <i class="fas fa-paw text-primary me-2"></i>
                <span class="fw-semibold">{{ m.animal_id or '' }}</span>
              </div>
            </td>
            <td>
              <div class="small">{{ m.treatment_date or '' }}</div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                {% if 'emergency' in cond_lower or 'critical' in cond_lower %}
                <span class="badge bg-danger me-2">!</span>
                {% elif 'routine' in cond_lower or 'checkup' in cond_lower %}
                <span class="badge bg-success me-2">✓</span>
                {% else %}
                <span class="badge bg-warning me-2">T</span>
                {% endif %}
                <span class="text-truncate" style="max-width: 150px;" title="{{ m.condition or '' }}">
                  {{ m.condition or '' }}
                </span>
              </div>
            </td>
            <td>
              <div class="text-truncate" style="max-width: 200px;" title="{{ m.treatment or '' }}">
                {{ m.treatment or '' }}
                {% if m.notes %}
                <i class="fas fa-sticky-note text-info ms-1" title="Has notes"></i>
                {% endif %}
              </div>
            </td>
            <td>
              {% if m.veterinarian %}
              <div class="d-flex align-items-center">
                <i class="fas fa-user-md text-success me-2"></i>
                <small>{{ m.veterinarian }}</small>
              </div>
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if m.next_checkup %}
                <!-- No server-side date math here; JS will mark overdue rows -->
                <div class="small fw-semibold">{{ m.next_checkup }}</div>
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if 'emergency' in cond_lower or 'critical' in cond_lower %}
              <span class="badge bg-danger">Critical</span>
              {% elif 'routine' in cond_lower or 'checkup' in cond_lower %}
              <span class="badge bg-success">Routine</span>
              {% else %}
              <span class="badge bg-warning">Treatment</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                <a class="btn btn-info" href="{{ url_for('view_medical', medical_id=m.id) }}" title="View Details">
                  <i class="fas fa-eye"></i>
                </a>
                <a class="btn btn-warning" href="{{ url_for('edit_medical', medical_id=m.id) }}" title="Edit Record">
                  <i class="fas fa-edit"></i>
                </a>

                {# Delete button: include a data-delete-url attribute so JS can set the modal form action #}
                <button type="button"
                        class="btn btn-danger btn-delete-record"
                        data-delete-url="{{ url_for('delete_medical', medical_id=m.id) }}"
                        data-record-id="{{ m.id }}"
                        data-record-summary="M-{{ m.id }} — {{ m.animal_id or 'Unknown' }} — {{ (m.condition or '')[:40] }}"
                        title="Delete Record">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9">
              <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No medical records found</h5>
                <p class="text-muted">This system tracks animal medical treatments and health records</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicalModal">
                  <i class="fas fa-plus me-2"></i> Add First Record
                </button>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {% if medical_records %}
  <div class="row mt-3">
    <div class="col-md-6">
      <small class="text-muted">Showing {{ medical_records|length }} record{% if medical_records|length != 1 %}s{% endif %} • Click rows to select</small>
    </div>
    <div class="col-md-6 text-end">
      <small class="text-muted">
        <i class="fas fa-circle text-danger small me-1"></i> Critical
        <i class="fas fa-circle text-warning small mx-2 me-1"></i> Treatment
        <i class="fas fa-circle text-success small mx-2 me-1"></i> Routine
      </small>
    </div>
  </div>
  {% endif %}
</div>

<!-- Add Medical Modal -->
<div class="modal fade" id="addMedicalModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add Medical Record</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('add_medical') }}">
        <div class="modal-body">
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <small>Add medical treatments, checkups, or health records for animals. All fields marked with * are required.</small>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Animal ID *</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-paw"></i></span>
                <input name="animal_id" class="form-control" required placeholder="e.g., A-001">
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Treatment Date *</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                <input name="treatment_date" type="date" class="form-control" required>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Condition *</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-heartbeat"></i></span>
              <input name="condition" class="form-control" required placeholder="e.g., Routine Checkup">
            </div>
            <small class="text-muted">Examples: Routine Checkup, Emergency Surgery, Vaccination, Injury Treatment</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Treatment *</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-syringe"></i></span>
              <input name="treatment" class="form-control" required placeholder="e.g., Vaccination, Medication">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Veterinarian</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user-md"></i></span>
                <input name="veterinarian" class="form-control" placeholder="Dr. Name">
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Next Checkup</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar-check"></i></span>
                <input name="next_checkup" type="date" class="form-control">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-sticky-note"></i></span>
              <textarea name="notes" class="form-control" rows="3" placeholder="Additional notes about the treatment, medication dosage, follow-up instructions..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-save me-2"></i>Save Record
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-trash me-2"></i>Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this medical record? This action cannot be undone.</p>
        <p id="deleteSummary" class="small text-muted"></p>
      </div>
      <div class="modal-footer">
        <form id="deleteMedicalForm" method="POST" class="d-inline">
          {# include CSRF token only if defined to avoid template errors #}
          {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .badge-sm {
    font-size: 0.65em;
    padding: 0.2em 0.4em;
  }
  .content-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }
  .sticky-top {
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .record-row:hover {
    background-color: rgba(0,123,255,0.05) !important;
    cursor: pointer;
  }
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0,0,0,.02);
  }
  .border-start {
    border-left-width: 4px !important;
  }
  .list-group-item {
    transition: background-color 0.2s;
  }
  .list-group-item:hover {
    background-color: rgba(0,0,0,.02);
  }

  /* Print-specific rules: show only the .content-card cards and hide application chrome */
  @media print {
    /* hide everything by default */
    body * {
      visibility: hidden;
    }
    /* show content cards and their contents */
    .content-card, .content-card * {
      visibility: visible;
    }
    /* position content at top-left for printing */
    .content-card {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      box-shadow: none !important;
    }
    /* hide interactive UI elements that shouldn't print */
    .btn, .btn-group, .filter-btn, .input-group, .pagination-controls, .modal, .dataTables_wrapper, .btn-close, .btn-outline-secondary {
      display: none !important;
    }
    /* ensure tables and rows break nicely across pages */
    table { page-break-inside: auto; }
    tr    { page-break-inside: avoid; page-break-after: auto; }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(button => {
      button.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        const today = new Date().toISOString().split('T')[0];
        const rows = document.querySelectorAll('.record-row');
        rows.forEach(row => {
          const condition = (row.getAttribute('data-condition') || '').toLowerCase();
          const hasVet = row.getAttribute('data-vet');
          const nextCheckup = row.getAttribute('data-next-checkup') || '';

          let show = true;
          if (filter === 'all') { show = true; }
          else if (filter === 'critical') { show = condition.includes('emergency') || condition.includes('critical'); }
          else if (filter === 'routine') { show = condition.includes('routine') || condition.includes('checkup'); }
          else if (filter === 'with_vet') { show = hasVet === 'true'; }
          else if (filter === 'upcoming') { show = nextCheckup && nextCheckup >= today; }

          row.style.display = show ? '' : 'none';
        });
      });
    });

    // Search box
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearch');
    if (searchInput) {
      searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.record-row');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      });
    }
    if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', function() {
        if (searchInput) searchInput.value = '';
        const rows = document.querySelectorAll('.record-row');
        rows.forEach(row => row.style.display = '');
      });
    }

    // Row click opens view (unless clicking a button/link)
    document.querySelectorAll('.record-row').forEach(row => {
      row.addEventListener('click', function(e) {
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' ||
            e.target.closest('a') || e.target.closest('button')) {
          return;
        }
        const viewBtn = this.querySelector('a[href*="view_medical"]');
        if (viewBtn) viewBtn.click();
      });
    });

    // Default treatment date in modal set to today if empty
    const treatmentDateInput = document.querySelector('input[name="treatment_date"]');
    if (treatmentDateInput && !treatmentDateInput.value) {
      treatmentDateInput.value = new Date().toISOString().split('T')[0];
    }

    // Mark overdue rows visually (client-side)
    const todayStr = new Date().toISOString().split('T')[0];
    document.querySelectorAll('.record-row').forEach(row => {
      const next = row.getAttribute('data-next-checkup') || '';
      if (next && next < todayStr) {
        const cell = row.querySelector('td:nth-child(7)');
        if (cell) cell.classList.add('text-danger');
      }
    });

    // Delete flow: open confirm modal, set form action and summary
    const deleteModalEl = document.getElementById('deleteConfirmModal');
    const deleteModal = deleteModalEl ? new bootstrap.Modal(deleteModalEl) : null;
    const deleteForm = document.getElementById('deleteMedicalForm');
    const deleteSummary = document.getElementById('deleteSummary');

    document.querySelectorAll('.btn-delete-record').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const delUrl = this.getAttribute('data-delete-url');
        const summary = this.getAttribute('data-record-summary') || '';
        if (deleteForm && delUrl) {
          deleteForm.action = delUrl;
        }
        if (deleteSummary) {
          deleteSummary.textContent = summary;
        }
        if (deleteModal) deleteModal.show();
      });
    });

    // Small card hover effect
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.transition = 'transform 0.2s ease';
      });
      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    });

    // PRINT button handler: uses window.print() with print CSS rules to limit printed content
    const printBtn = document.getElementById('printMedical');
    if (printBtn) {
      printBtn.addEventListener('click', function() {
        // Close any open modals programmatically (if using Bootstrap)
        try {
          document.querySelectorAll('.modal.show').forEach(m => {
            const modalInstance = bootstrap.Modal.getInstance(m);
            if (modalInstance) modalInstance.hide();
          });
        } catch (err) {
          // ignore if bootstrap is not defined
        }
        // Trigger print - @media print will decide what's shown
        window.print();
      });
    }
  });
</script>
{% endblock %}
