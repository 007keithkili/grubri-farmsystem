{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block page_subtitle %}Performance overview - {{ start_date|default('') }}{% if end_date %} - {{ end_date }}{% else %} (last 30 days){% endif %}{% endblock %}

{% block extra_css %}
<style>
/* ===== VIBRANT COLOR PALETTE ===== */
:root {
  --primary: #2563eb;        /* bright blue */
  --primary-light: #dbeafe;
  --secondary: #7c3aed;       /* vivid purple */
  --accent: #f59e0b;          /* warm orange */
  --success: #10b981;         /* emerald green */
  --danger: #ef4444;          /* red */
  --warning: #fbbf24;         /* amber */
  --text-dark: #0f172a;
  --text-muted: #475569;
  --bg-card: #ffffff;
  --bg-soft: #f8fafc;
  --shadow: 0 20px 30px -12px rgba(0,0,0,0.1);
  --shadow-hover: 0 25px 40px -16px rgba(0,0,0,0.2);
  --radius: 20px;
}

/* ===== Overall layout ===== */
.container-dashboard {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 24px;
  align-items: start;
}
@media (max-width:1100px){
  .container-dashboard { grid-template-columns: 1fr; }
}

/* ===== Hero banner ===== */
.hero-banner {
  border-radius: 14px;
  overflow: hidden;
  background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
  color: #fff;
  padding: 28px 28px;
  margin-bottom: 18px;
  box-shadow: 0 12px 36px rgba(2, 6, 23, 0.15);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
}
.hero-left h1 { font-weight:800; margin:0; font-size:1.7rem; }
.hero-left p { margin:0.25rem 0 0 0; opacity:0.95; }
.hero-meta {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(4px);
  padding:10px 16px;
  border-radius:40px;
  text-align:right;
}
.hero-meta small { display:block; opacity:0.9; font-size:0.85rem; }
.hero-meta .period { font-weight:700; font-size:1rem; }

/* ===== KPI GRID ===== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 18px;
  margin-bottom: 24px;
}
@media (max-width:900px){ .kpi-grid { grid-template-columns: repeat(2,1fr); } }
@media (max-width:560px){ .kpi-grid { grid-template-columns: 1fr; } }
.kpi {
  border-radius: 16px;
  padding: 18px 14px;
  display:flex;
  gap:12px;
  align-items:center;
  background: var(--bg-card);
  box-shadow: var(--shadow);
  transition: transform 0.15s, box-shadow 0.15s;
  border: 1px solid #eef2f6;
}
.kpi:hover { transform: translateY(-6px); box-shadow: var(--shadow-hover); }
.kpi .icon {
  min-width:60px; min-height:60px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:24px;
  color: #fff;
}
.kpi .meta small { color:var(--text-muted); display:block; font-size:0.8rem; }
.kpi .meta .value { font-weight:800; font-size:1.5rem; color:var(--text-dark); }
.icon.paw { background: linear-gradient(145deg, #2563eb, #1e40af); }
.icon.profit { background: linear-gradient(145deg, #10b981, #047857); }
.icon.feed { background: linear-gradient(145deg, #f59e0b, #b45309); }
.icon.staff { background: linear-gradient(145deg, #8b5cf6, #6d28d9); }
.icon.med { background: linear-gradient(145deg, #ec4899, #be185d); }
.icon.manage { background: linear-gradient(145deg, #6b7280, #374151); }

/* ===== Export panel ===== */
.export-panel {
  background: white;
  border-radius: 14px;
  padding: 14px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:20px;
  box-shadow: var(--shadow);
  border: 1px solid #e2e8f0;
  flex-wrap:wrap;
}
.export-left { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.export-right { display:flex; gap:6px; align-items:center; }
.export-panel input.form-control, .export-panel .form-select {
  border: 1px solid #cbd5e1;
  border-radius: 30px;
  padding: 6px 14px;
  font-size:0.85rem;
}
.btn {
  border: none;
  border-radius: 30px;
  padding: 6px 16px;
  font-weight:500;
  transition: 0.15s;
}
.btn-primary { background: var(--primary); color:white; }
.btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(37,99,235,0.3); }
.btn-outline-primary { border:1px solid var(--primary); color:var(--primary); background:transparent; }
.btn-outline-success { border:1px solid var(--success); color:var(--success); }
.btn-outline-danger { border:1px solid var(--danger); color:var(--danger); }
.btn-outline-secondary { border:1px solid var(--text-muted); color:var(--text-muted); }
.btn-outline:hover { background: var(--primary); color:white; border-color:var(--primary); }

/* ===== Right rail ===== */
.right-rail { display:flex; flex-direction:column; gap:18px; }
.rail-card {
  background: var(--bg-card);
  border-radius:16px;
  padding:18px;
  box-shadow: var(--shadow);
  border: 1px solid #eef2f6;
}
.performance-figure .big { font-size:1.8rem; font-weight:900; color:var(--primary); }
.activity-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; max-height:240px; overflow:auto; }
.activity-item { display:flex; gap:12px; align-items:center; padding:8px; border-radius:12px; background: var(--bg-soft); }
.activity-item .dot { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; }

/* ===== ENHANCED DATA CARDS ===== */
.data-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 22px;
  margin-bottom: 22px;
}
@media (max-width:700px){ .data-grid { grid-template-columns: 1fr; } }
.data-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  transition: transform 0.2s, box-shadow 0.2s;
  overflow: hidden;
  border: 1px solid #eef2f6;
}
.data-card:hover {
  transform: translateY(-6px);
  box-shadow: var(--shadow-hover);
}
.card-header {
  padding: 18px 22px 12px 22px;
  background: linear-gradient(135deg, #f1f5f9, #e6edf5);
  border-bottom: 2px solid rgba(37,99,235,0.2);
  display: flex;
  align-items: center;
  gap: 12px;
}
.card-header i {
  font-size: 1.5rem;
  color: white;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  padding: 10px;
  border-radius: 14px;
  box-shadow: 0 6px 10px rgba(37,99,235,0.2);
}
.card-header h6 {
  margin: 0;
  font-weight: 800;
  color: var(--text-dark);
  font-size: 1.2rem;
  letter-spacing: -0.02em;
}
.card-body {
  padding: 20px 22px;
}
.stat-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 14px;
  font-size: 1rem;
  padding: 6px 0;
  border-bottom: 1px solid #e9eef3;
}
.stat-row:last-child { border-bottom: none; }
.stat-row .label {
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}
.stat-row .label i {
  font-size: 0.9rem;
  color: var(--primary);
  background: var(--primary-light);
  padding: 4px;
  border-radius: 8px;
}
.stat-row .value {
  font-weight: 800;
  color: var(--text-dark);
  background: linear-gradient(145deg, #f8fafc, #f1f5f9);
  padding: 4px 14px;
  border-radius: 40px;
  font-size: 1rem;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}
.financial .value { color: var(--primary); background: var(--primary-light); }
.progress-bar {
  height: 10px;
  background: #e2e8f0;
  border-radius: 30px;
  overflow: hidden;
  margin: 8px 0 16px 0;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  border-radius: 30px;
  transition: width 0.3s ease;
  box-shadow: 0 0 8px var(--primary-light);
}
.quick-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
}
.quick-actions .btn {
  background: var(--bg-soft);
  border: 1px solid #d1d9e6;
  border-radius: 40px;
  padding: 8px 18px;
  font-weight: 600;
  color: var(--text-dark);
  transition: 0.15s;
}
.quick-actions .btn:hover {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
  transform: translateY(-3px);
}
.period-overview {
  background: linear-gradient(145deg, #f0f7ff, #e9f3fa);
  border-left: 6px solid var(--primary);
}
.period-overview .card-header {
  background: transparent;
  border-bottom: 1px solid #b3d0f0;
}
.period-overview .stat-row .value { background: white; }
.muted { color: var(--text-muted); font-size: 0.85rem; }
.mb-2 { margin-bottom: 12px; }
.mt-2 { margin-top: 12px; }
</style>
{% endblock %}

{% block content %}
<div class="hero-banner">
  <div class="hero-left">
    <h1>Grubri-farm management system</h1>
    <p>Insights – financials, production, livestock and operations in one place.</p>
  </div>
  <div class="hero-meta">
    <small>Overview period</small>
    <div class="period">{{ start_date|default('Last 30 days') }}{% if end_date %} – {{ end_date }}{% endif %}</div>
  </div>
</div>

<div class="export-panel">
  <div class="export-left">
    <div>
      <label class="form-label small mb-1">Start</label>
      <input id="startDate" type="date" class="form-control form-control-sm" value="{{ start_date|default('') }}">
    </div>
    <div>
      <label class="form-label small mb-1">End</label>
      <input id="endDate" type="date" class="form-control form-control-sm" value="{{ end_date|default('') }}">
    </div>
    <div>     
      <select id="reportType" class="form-select form-select-sm">
        <option value="comprehensive">Comprehensive</option>
        <option value="financial">Financial</option>
        <option value="livestock">Livestock</option>
        <option value="production">Production</option>
        <option value="inventory">Inventory</option>
        <option value="custom">Custom</option>
      </select>
    </div>
    <div style="align-self:end;">
      <button id="generateBtn" class="btn btn-primary btn-sm">Apply</button>
    </div>
  </div>

  <div class="export-right">
    <button id="exportCsv" class="btn btn-outline-primary btn-sm">CSV</button>
    <button id="exportExcel" class="btn btn-outline-success btn-sm">Excel</button>
    <button id="exportPdf" class="btn btn-outline-danger btn-sm">PDF</button>
    <button id="printBtn" class="btn btn-outline-secondary btn-sm">Print</button>
  </div>
</div>

<div class="container-dashboard">
  <div> <!-- main column -->
    <!-- KPI GRID -->
    <div class="kpi-grid">
      <div class="kpi">
        <div class="icon paw"><i class="fas fa-paw"></i></div>
        <div class="meta">
          <small>Total Animals</small>
          <div class="value">{{ total_animals|default(0) }}</div>
          <small class="muted">head</small>
        </div>
      </div>
      <div class="kpi">
        <div class="icon profit"><i class="fas fa-chart-line"></i></div>
        <div class="meta">
          <small>Net Profit</small>
          <div class="value">Ksh {{ '%.2f' % (net_profit|default(0)) }}</div>
          <small class="muted">Period</small>
        </div>
      </div>
      <div class="kpi">
        <div class="icon feed"><i class="fas fa-seedling"></i></div>
        <div class="meta">
          <small>Feed Consumed</small>
          <div class="value">{{ (feed_series|default([]) | sum) }}</div>
          <small class="muted">kg</small>
        </div>
      </div>
      <div class="kpi">
        <div class="icon staff"><i class="fas fa-users"></i></div>
        <div class="meta">
          <small>Total Staff</small>
          <div class="value">{{ total_staff|default(0) }}</div>
          <small class="muted">employees</small>
        </div>
      </div>
      <div class="kpi">
        <div class="icon med"><i class="fas fa-notes-medical"></i></div>
        <div class="meta">
          <small>Medical Records</small>
          <div class="value">{{ medical_count|default(0) }}</div>
          <small class="muted">records</small>
        </div>
      </div>
      <div class="kpi">
        <div class="icon manage"><i class="fas fa-user-tie"></i></div>
        <div class="meta">
          <small>Staff Management</small>
          <div class="value">{{ total_staff|default(0) }}</div>
          <small class="muted">manage staff</small>
        </div>
      </div>
    </div>

    <!-- DATA CARDS -->
    <div class="data-grid">
      <!-- Financial Summary -->
      <div class="data-card financial">
        <div class="card-header">
          <i class="fas fa-coins"></i>
          <h6>Financial Summary</h6>
        </div>
        <div class="card-body">
          <div class="stat-row">
            <span class="label"><i class="fas fa-arrow-up"></i> Total Income</span>
            <span class="value">Ksh {{ '%.2f' % (total_income|default(0)) }}</span>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-arrow-down"></i> Total Expense</span>
            <span class="value">Ksh {{ '%.2f' % (total_expense|default(0)) }}</span>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-balance-scale"></i> Net Profit</span>
            <span class="value">Ksh {{ '%.2f' % (net_profit|default(0)) }}</span>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-percent"></i> Profit Margin</span>
            <span class="value">
              {% if total_income and total_income|float > 0 %}
                {{ '%.1f' % ((net_profit|default(0) / total_income * 100)) }}%
              {% else %}0%{% endif %}
            </span>
          </div>
        </div>
      </div>

      <!-- Task Progress -->
      <div class="data-card">
        <div class="card-header">
          <i class="fas fa-tasks"></i>
          <h6>Task Status</h6>
        </div>
        <div class="card-body">
          <div class="stat-row">
            <span class="label"><i class="fas fa-clock"></i> Pending</span>
            <span class="value">{{ task_counts.Pending|default(0) }}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (task_counts.Pending|default(0) / (task_counts.Pending|default(0) + task_counts['In Progress']|default(0) + task_counts.Completed|default(0)) * 100) if (task_counts.Pending|default(0) + task_counts['In Progress']|default(0) + task_counts.Completed|default(0)) > 0 else 0 }}%"></div>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-spinner"></i> In Progress</span>
            <span class="value">{{ task_counts['In Progress']|default(0) }}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (task_counts['In Progress']|default(0) / (task_counts.Pending|default(0) + task_counts['In Progress']|default(0) + task_counts.Completed|default(0)) * 100) if (task_counts.Pending|default(0) + task_counts['In Progress']|default(0) + task_counts.Completed|default(0)) > 0 else 0 }}%"></div>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-check-circle"></i> Completed</span>
            <span class="value">{{ task_counts.Completed|default(0) }}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (task_counts.Completed|default(0) / (task_counts.Pending|default(0) + task_counts['In Progress']|default(0) + task_counts.Completed|default(0)) * 100) if (task_counts.Pending|default(0) + task_counts['In Progress']|default(0) + task_counts.Completed|default(0)) > 0 else 0 }}%"></div>
          </div>
        </div>
      </div>

      <!-- Feed & Weight Overview -->
      <div class="data-card">
        <div class="card-header">
          <i class="fas fa-weight"></i>
          <h6>Feed & Weight</h6>
        </div>
        <div class="card-body">
          <div class="stat-row">
            <span class="label"><i class="fas fa-apple-alt"></i> Total Feed</span>
            <span class="value">{{ (feed_series|default([]) | sum) }} kg</span>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-chart-line"></i> Avg Daily Feed</span>
            <span class="value">
              {% set feed_len = feed_series|default([])|length %}
              {% if feed_len > 0 %}
                {{ '%.1f' % ((feed_series|sum) / feed_len) }} kg
              {% else %}0 kg{% endif %}
            </span>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-balance-scale"></i> Latest Avg Weight</span>
            <span class="value">
              {% if avg_weight_series|default([]) %}
                {{ '%.1f' % (avg_weight_series[-1]) }} kg
              {% else %}—{% endif %}
            </span>
          </div>
          <div class="stat-row">
            <span class="label"><i class="fas fa-exchange-alt"></i> Weight Change</span>
            <span class="value">
              {% if avg_weight_series|default([])|length > 1 %}
                {% set change = avg_weight_series[-1] - avg_weight_series[0] %}
                {{ '%.1f' % change }} kg
              {% else %}—{% endif %}
            </span>
          </div>
        </div>
      </div>

      <!-- Production Summary (if data exists) -->
      {% set has_production = production_labels is defined and production_labels|length and production_values is defined and production_values|length %}
      {% if has_production %}
      <div class="data-card">
        <div class="card-header">
          <i class="fas fa-chart-pie"></i>
          <h6>Top Production</h6>
        </div>
        <div class="card-body">
          {% for i in range(production_labels|length) %}
            {% if i < 3 %}
            <div class="stat-row">
              <span class="label">{{ production_labels[i] }}</span>
              <span class="value">{{ production_values[i] }}</span>
            </div>
            {% endif %}
          {% endfor %}
          {% if production_labels|length > 3 %}
            <div class="muted mt-2">+{{ production_labels|length - 3 }} more categories</div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Weekly Activity (if data exists) -->
      {% set has_weekly = weekly_labels is defined and weekly_labels|length and weekly_values is defined and weekly_values|length %}
      {% if has_weekly %}
      <div class="data-card">
        <div class="card-header">
          <i class="fas fa-calendar-week"></i>
          <h6>Weekly Activity</h6>
        </div>
        <div class="card-body">
          {% for i in range(weekly_labels|length) %}
            <div class="stat-row">
              <span class="label">{{ weekly_labels[i] }}</span>
              <span class="value">{{ weekly_values[i] }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Quick Actions (if no production/weekly) -->
      {% if not has_production and not has_weekly %}
      <div class="data-card">
        <div class="card-header">
          <i class="fas fa-rocket"></i>
          <h6>Quick Actions</h6>
        </div>
        <div class="card-body">
          <p class="muted">Navigate to key sections</p>
          <div class="quick-actions">
            <a class="btn" href="#"><i class="fas fa-chart-bar"></i> Financial</a>
            <a class="btn" href="#"><i class="fas fa-paw"></i> Livestock</a>
            <a class="btn" href="#"><i class="fas fa-seedling"></i> Production</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Period Overview Card -->
    <div class="data-card period-overview" style="grid-column: span 2;">
      <div class="card-header">
        <i class="fas fa-calendar-alt"></i>
        <h6>Period Overview</h6>
      </div>
      <div class="card-body">
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
          <div><span class="muted">Start:</span> <strong>{{ start_date|default('N/A') }}</strong></div>
          <div><span class="muted">End:</span> <strong>{{ end_date|default('N/A') }}</strong></div>
          <div><span class="muted">Days in range:</span> <strong>{{ days|default([])|length }}</strong></div>
          <div><span class="muted">Data points:</span> <strong>{{ income_series|default([])|length }}</strong></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT RAIL -->
  <aside class="right-rail">
    <div class="rail-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h6 style="margin:0;">Total View Performance</h6>
          <small class="muted">Overview metrics</small>
        </div>
        <div style="text-align:right;">
          <div class="big">Ksh {{ '%.0f' % ((total_income|default(0)) - (total_expense|default(0))) }}</div>
          <div class="muted">Net</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="width:120px; height:120px; background:#eef2f6; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#64748b;">Chart</div>
        <div style="flex:1;">
          <div class="muted">Guide Views</div>
          <div style="font-weight:700; margin-top:6px;">{{ (total_animals|default(0)) + (total_staff|default(0)) }} items</div>
          <div class="muted" style="margin-top:8px;">Improve your score with focused checks</div>
        </div>
      </div>
    </div>

    <!-- Recent Activity (FIXED SYNTAX) -->
    <div class="rail-card">
      <h6 style="margin:0 0 8px 0;">Recent Activity</h6>
      <ul class="activity-list">
        {% for act in recent_activity|default([]) %}
          <li class="activity-item">
            <div class="dot" style="background:
                 {% if act.badge == 'A' %}#2563eb
                 {% elif act.badge == 'S' %}#8b5cf6
                 {% elif act.badge == 'F' %}#f59e0b
                 {% elif act.badge == 'M' %}#ec4899
                 {% else %}#94a3b8
                 {% endif %}">{{ act.badge|default('-') }}</div>
            <div>
              <strong>{{ act.title|default('Unnamed') }}</strong>
              <div class="muted">{{ act.time_ago|default('') }}{% if act.subtitle %} – {{ act.subtitle }}{% endif %}</div>
            </div>
          </li>
        {% else %}
          <li class="activity-item">
            <div class="dot" style="background:#94a3b8">–</div>
            <div><strong>No recent activity</strong><div class="muted">No events found</div></div>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="rail-card">
      <h6 style="margin:0 0 8px 0;">Quick Export</h6>
      <p class="muted">Create printable or downloadable data for stakeholders.</p>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-primary btn-sm" id="btnExportPdf">Export PDF</button>
        <button class="btn btn-outline-primary btn-sm" id="btnExportExcel">Export Excel</button>
      </div>
    </div>
  </aside>
</div>
{% endblock %}

{% block extra_js %}
<!-- JavaScript unchanged – exactly as provided (keeps all backend logic) -->
<script>
(function(){
  /***** SANITIZE & ALIGN SERIES (do this before creating any charts) *****/

  // Raw arrays from template (server must supply these exact names)
  const rawDays = {{ days|default([])|tojson }};
  const rawIncome = {{ income_series|default([])|tojson }};
  const rawExpense = {{ expense_series|default([])|tojson }};
  const rawFeed = {{ feed_series|default([])|tojson }};
  const rawAvgWeight = {{ avg_weight_series|default([])|tojson }};
  const taskCounts = {{ task_counts|default({'Pending':0,'In Progress':0,'Completed':0})|tojson }};

  // Optional: latest metrics injected by backend (object) or empty
  const latestDayFromTemplate = "{{ latest_day|default('') }}";
  const latestMetricsFromTemplate = {{ latest_metrics|default({})|tojson }};

  // Optional production/weekly data from backend (may be undefined/empty)
  const productionLabelsTemplate = {{ production_labels|default([])|tojson }};
  const productionValuesTemplate = {{ production_values|default([])|tojson }};
  const weeklyLabelsTemplate = {{ weekly_labels|default([])|tojson }};
  const weeklyValuesTemplate = {{ weekly_values|default([])|tojson }};

  // Server-provided reliable totals (use these for displays and the donut)
  const totalIncomeFromServer = Number({{ total_income|default(0)|tojson }});
  const totalExpenseFromServer = Number({{ total_expense|default(0)|tojson }});

  // Helper: coerce values to numbers, keep 0 for invalid values
  function toNumberArray(arr){
    if (!Array.isArray(arr)) return [];
    return arr.map(v => {
      if (v === null || v === undefined || v === '') return 0;
      if (typeof v === 'object') {
        // If backend accidentally sent small objects (safer to guard), try common numeric props
        for (const k of ['value','y','amount','qty','count']) {
          if (v[k] !== undefined && v[k] !== null) return Number(v[k]) || 0;
        }
        return 0;
      }
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    });
  }

  // Detect ISO date-like strings (YYYY-MM-DD)
  function isLikelyDateString(s){
    return typeof s === 'string' && /^\d{4}-\d{2}-\d{2}/.test(s);
  }

  // Normalize: zip arrays, sort by day (if date-like), and return aligned arrays
  function normalizeSeries(daysArr, incArr, expArr, feedArr, wArr){
    const daysCopy = Array.isArray(daysArr) ? daysArr.slice() : [];
    const inc = toNumberArray(incArr);
    const exp = toNumberArray(expArr);
    const feed = toNumberArray(feedArr);
    const w = toNumberArray(wArr);

    if (daysCopy.length && isLikelyDateString(daysCopy[0])) {
      // Zip up to the max length and allow missing numeric values as 0
      const maxLen = Math.max(daysCopy.length, inc.length, exp.length, feed.length, w.length);
      const zipped = [];
      for (let i=0;i<maxLen;i++){
        zipped.push({
          day: daysCopy[i] !== undefined && daysCopy[i] !== null ? String(daysCopy[i]) : null,
          income: inc[i] !== undefined ? inc[i] : 0,
          expense: exp[i] !== undefined ? exp[i] : 0,
          feed: feed[i] !== undefined ? feed[i] : 0,
          avgWeight: w[i] !== undefined ? w[i] : 0
        });
      }
      // Keep entries that have day defined, sort them, then append any without day (if any)
      const withDay = zipped.filter(z => z.day);
      const withoutDay = zipped.filter(z => !z.day);
      withDay.sort((a,b) => (a.day > b.day ? 1 : (a.day < b.day ? -1 : 0)));
      const final = withDay.concat(withoutDay);
      return {
        days: final.map(x => x.day || ''),
        income: final.map(x => x.income || 0),
        expense: final.map(x => x.expense || 0),
        feed: final.map(x => x.feed || 0),
        avgWeight: final.map(x => x.avgWeight || 0)
      };
    }

    // If days are not date-like: align by shortest length (safer)
    const minLen = Math.min(
      Array.isArray(daysCopy) ? daysCopy.length : 0,
      inc.length,
      exp.length,
      feed.length,
      w.length
    );
    if (minLen > 0) {
      return {
        days: daysCopy.slice(0,minLen).map(String),
        income: inc.slice(0,minLen),
        expense: exp.slice(0,minLen),
        feed: feed.slice(0,minLen),
        avgWeight: w.slice(0,minLen)
      };
    }

    // Fallback: if days empty but numeric arrays exist, create placeholder labels 'pt1'..'ptN' to preserve indices
    const maxLen = Math.max(daysCopy.length, inc.length, exp.length, feed.length, w.length);
    const daysOut = [];
    const incOut = [], expOut = [], feedOut = [], wOut = [];
    for (let i=0;i<maxLen;i++){
      daysOut.push(daysCopy[i] !== undefined && daysCopy[i] !== null ? String(daysCopy[i]) : `pt${i+1}`);
      incOut.push(inc[i] !== undefined ? inc[i] : 0);
      expOut.push(exp[i] !== undefined ? exp[i] : 0);
      feedOut.push(feed[i] !== undefined ? feed[i] : 0);
      wOut.push(w[i] !== undefined ? w[i] : 0);
    }
    return { days: daysOut, income: incOut, expense: expOut, feed: feedOut, avgWeight: wOut };
  }

  // Run normalization
  const normalized = normalizeSeries(rawDays, rawIncome, rawExpense, rawFeed, rawAvgWeight);

  // Provide console warnings for debugging on mismatches
  function logIfMismatch(label, arr, labels){
    if (!Array.isArray(arr) || !Array.isArray(labels)) return;
    if (arr.length !== labels.length) {
      console.warn(`${label} length (${arr.length}) != labels length (${labels.length}). Data was sanitized/trimmed/padded by normalizer.`);
    }
    console.debug(`${label} preview:`, arr.slice(0,8));
  }
  logIfMismatch('income', normalized.income, normalized.days);
  logIfMismatch('expense', normalized.expense, normalized.days);
  logIfMismatch('feed', normalized.feed, normalized.days);
  logIfMismatch('avgWeight', normalized.avgWeight, normalized.days);

  // Final arrays used by chart creation below
  const days = normalized.days;
  const income = normalized.income;
  const expense = normalized.expense;
  const feed = normalized.feed;
  const avgWeight = normalized.avgWeight;

  /***** END SANITIZATION; NOW CREATE BAR CHARTS (using sanitized arrays) *****/

  /* ----- Label formatting + axis options to avoid overcrowding ----- */
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  function shortLabelFromISO(iso){
    if (!iso || typeof iso !== 'string') return String(iso || '');
    const parts = iso.split('-'); // expecting YYYY-MM-DD
    if (parts.length < 3) return iso;
    const d = parts[2].replace(/^0/, '');
    const m = monthNames[Number(parts[1]) - 1] || parts[1];
    return `${d} ${m}`;
  }
  // displayLabels used for x-axis text. Keep it in sync when appending points.
  const displayLabels = (days.length && isLikelyDateString(days[0])) ? days.map(shortLabelFromISO) : days.slice();

  // adapt ticks to viewport width, but keep within sensible bounds
  const maxTicksToShow = Math.min(12, Math.max(5, Math.floor((window.innerWidth || 1000) / 100)));
  const commonXAxisOptions = {
    ticks: {
      autoSkip: true,
      maxTicksLimit: maxTicksToShow,
      maxRotation: 45,
      minRotation: 0,
      callback: function(value) { return value; }
    },
    grid: { display: false }
  };

  /* 1) Financial trend -> grouped bar (Income, Expense) */
  const finCtx = document.getElementById('chartFinancial');
  if (finCtx) {
    window.finChart = new Chart(finCtx, {
      type: 'bar',
      data: {
        labels: displayLabels,
        datasets: [
          { label: 'Income', data: income, backgroundColor: '#16a34a' },
          { label: 'Expense', data: expense, backgroundColor: '#ef4444' }
        ]
      },
      options: {
        maintainAspectRatio:false,
        plugins: { legend: { position: 'bottom' }, tooltip: { mode: 'index', intersect:false,
          callbacks: {
            title: function(items) {
              if (!items || !items.length) return '';
              const idx = items[0].dataIndex;
              return days[idx] || '';
            }
          }
        } },
        scales: { x: commonXAxisOptions, y: { beginAtZero:true } }
      }
    });
  }

  /* 2) Tasks -> horizontal bar showing counts */
  const tCtx = document.getElementById('chartTasks');
  if (tCtx) {
    window.tasksChart = new Chart(tCtx, {
      type: 'bar',
      data: {
        labels: ['Pending','In Progress','Completed'],
        datasets: [{ label:'Tasks', data: [taskCounts.Pending||0, taskCounts['In Progress']||0, taskCounts.Completed||0], backgroundColor:['#f59e0b','#3b82f6','#10b981'] }]
      },
      options: {
        indexAxis: 'y',
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales: { x:{ beginAtZero:true } }
      }
    });
  }

  /* 3) Feed -> vertical bar by day (displayLabels) */
  const fCtx = document.getElementById('chartFeed');
  if (fCtx) {
    window.feedChart = new Chart(fCtx, {
      type: 'bar',
      data: { labels: displayLabels, datasets: [{ label:'Feed (kg)', data: feed, backgroundColor:'#f97316' }] },
      options: { maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x: commonXAxisOptions, y:{ beginAtZero:true } } }
    });
  }

  /* 4) Weight -> vertical bar by day (displayLabels) */
  const wCtx = document.getElementById('chartWeight');
  if (wCtx) {
    window.weightChart = new Chart(wCtx, {
      type: 'bar',
      data: { labels: displayLabels, datasets: [{ label:'Avg weight (kg)', data: avgWeight, backgroundColor:'#7c3aed' }] },
      options: { maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x: commonXAxisOptions, y:{ beginAtZero:true } } }
    });
  }

  /* 5) Performance (right rail) -> horizontal two-bar showing Income vs Expense */
  const perfCtx = document.getElementById('performanceDonut');
  if (perfCtx) {
    window.perfChart = new Chart(perfCtx, {
      type: 'bar',
      data: {
        labels: ['Income','Expense'],
        datasets: [{ label: 'Ksh', data: [totalIncomeFromServer || 0, totalExpenseFromServer || 0], backgroundColor:['#10b981','#ef4444'] }]
      },
      options: { indexAxis:'y', maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true } } }
    });
  }

  /* 6) Production chart (if provided) -> vertical bar */
  if (Array.isArray(productionLabelsTemplate) && productionLabelsTemplate.length
      && Array.isArray(productionValuesTemplate) && productionValuesTemplate.length) {
    const prodCtx = document.getElementById('chartProduction');
    if (prodCtx) {
      const prodVals = toNumberArray(productionValuesTemplate);
      window.prodChart = new Chart(prodCtx, {
        type: 'bar',
        data: { labels: productionLabelsTemplate, datasets: [{ label:'Value', data: prodVals, backgroundColor:'#f59e0b' }] },
        options: { maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    }
  } else {
    console.debug('Production chart not rendered: production_labels/production_values not provided by backend.');
  }

  /* 7) Weekly chart (if provided) -> vertical bar */
  if (Array.isArray(weeklyLabelsTemplate) && weeklyLabelsTemplate.length
      && Array.isArray(weeklyValuesTemplate) && weeklyValuesTemplate.length) {
    const weeklyCtx = document.getElementById('chartWeekly');
    if (weeklyCtx) {
      const wVals = toNumberArray(weeklyValuesTemplate);
      window.weeklyChart = new Chart(weeklyCtx, {
        type: 'bar',
        data: { labels: weeklyLabelsTemplate, datasets: [{ label:'Activity', data: wVals, backgroundColor:'#3b82f6' }] },
        options: { maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    }
  } else {
    console.debug('Weekly chart not rendered: weekly_labels/weekly_values not provided by backend.');
  }

  // EXPORT helper - neutralised to avoid server url_for lookups
  window.postReport = function(format){
    const start = document.getElementById('startDate')?.value || '';
    const end = document.getElementById('endDate')?.value || '';
    const type = document.getElementById('reportType')?.value || 'comprehensive';
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '#';  // neutralised: no server endpoint called
    form.style.display='none';
    [['start_date',start],['end_date',end],['report_type',type],['format',format]].forEach(([n,v]) => {
      const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i);
    });
    document.body.appendChild(form); form.submit();
  };

  document.getElementById('exportCsv')?.addEventListener('click', ()=>postReport('csv'));
  document.getElementById('exportExcel')?.addEventListener('click', ()=>postReport('excel'));
  document.getElementById('exportPdf')?.addEventListener('click', ()=>postReport('pdf'));
  document.getElementById('printBtn')?.addEventListener('click', ()=> window.print());

  // Apply filter (reload with params so backend re-renders)
  document.getElementById('generateBtn')?.addEventListener('click', function(){
    const s = document.getElementById('startDate')?.value;
    const e = document.getElementById('endDate')?.value;
    const p = new URLSearchParams();
    if (s) p.set('start', s);
    if (e) p.set('end', e);
    const url = window.location.pathname + (p.toString() ? ('?' + p.toString()) : '');
    window.location.href = url;
  });

  /***** OPTIONAL: Append latest single-day metrics if backend provided them *****/
  // Updated to keep displayLabels in sync with days[]
  function tryAppendLatestPoint(latestObj){
    try {
      if (!latestObj) return;
      const newDay = latestObj.day || latestObj.date;
      if (!newDay) return;
      const lastDisplayed = (days && days.length) ? days[days.length-1] : null;
      // Only append if different/newer than last displayed
      if (newDay && newDay !== lastDisplayed) {
        days.push(newDay);
        income.push(Number(latestObj.income || 0));
        expense.push(Number(latestObj.expense || 0));
        feed.push(Number(latestObj.feed || 0));
        avgWeight.push(Number(latestObj.avgWeight || 0));
        // also push formatted label
        displayLabels.push(isLikelyDateString(newDay) ? shortLabelFromISO(newDay) : String(newDay));

        // Update bar charts that rely on these arrays
        if (window.finChart) {
          window.finChart.data.labels = displayLabels;
          window.finChart.data.datasets[0].data = income;
          window.finChart.data.datasets[1].data = expense;
          window.finChart.update();
        }
        if (window.feedChart) {
          window.feedChart.data.labels = displayLabels;
          window.feedChart.data.datasets[0].data = feed;
          window.feedChart.update();
        }
        if (window.weightChart) {
          window.weightChart.data.labels = displayLabels;
          window.weightChart.data.datasets[0].data = avgWeight;
          window.weightChart.update();
        }
      }
    } catch (e) {
      console.warn('Error appending latest metrics:', e);
    }
  }

  // Try template-provided latest metrics first
  if (latestDayFromTemplate && latestMetricsFromTemplate && latestMetricsFromTemplate.day === latestDayFromTemplate) {
    tryAppendLatestPoint(Object.assign({}, latestMetricsFromTemplate, { day: latestDayFromTemplate }));
  } else if (latestMetricsFromTemplate && latestMetricsFromTemplate.day) {
    tryAppendLatestPoint(latestMetricsFromTemplate);
  } else if (latestDayFromTemplate && !latestMetricsFromTemplate.day) {
    // Backend provided latest day string only: append a zero-valued point (safer than faking data)
    tryAppendLatestPoint({ day: latestDayFromTemplate, income:0, expense:0, feed:0, avgWeight:0 });
  }

  // If latest_metrics provided production/weekly overrides, update those charts (safe guard)
  if (latestMetricsFromTemplate && typeof latestMetricsFromTemplate === 'object') {
    try {
      if (latestMetricsFromTemplate.production_labels && latestMetricsFromTemplate.production_values && window.prodChart) {
        window.prodChart.data.labels = latestMetricsFromTemplate.production_labels;
        window.prodChart.data.datasets[0].data = toNumberArray(latestMetricsFromTemplate.production_values);
        window.prodChart.update();
      }
      if (latestMetricsFromTemplate.weekly_labels && latestMetricsFromTemplate.weekly_values && window.weeklyChart) {
        window.weeklyChart.data.labels = latestMetricsFromTemplate.weekly_labels;
        window.weeklyChart.data.datasets[0].data = toNumberArray(latestMetricsFromTemplate.weekly_values);
        window.weeklyChart.update();
      }
      // update perfChart if provided
      if ((latestMetricsFromTemplate.total_income !== undefined || latestMetricsFromTemplate.total_expense !== undefined) && window.perfChart) {
        const inc = Number(latestMetricsFromTemplate.total_income || totalIncomeFromServer || 0);
        const exp = Number(latestMetricsFromTemplate.total_expense || totalExpenseFromServer || 0);
        window.perfChart.data.datasets[0].data = [inc, exp];
        window.perfChart.update();
      }
      // update tasks if counts provided
      if (latestMetricsFromTemplate.task_counts && window.tasksChart) {
        const tc = latestMetricsFromTemplate.task_counts;
        window.tasksChart.data.datasets[0].data = [tc.Pending||0, tc['In Progress']||0, tc.Completed||0];
        window.tasksChart.update();
      }
    } catch(e) { console.warn('Error applying latest metrics production/weekly overrides', e); }
  }

  // Expose safe function to manually append metrics from other client code (e.g., after an AJAX post)
  window.appendLatestMetrics = function(obj){
    // expects { day: 'YYYY-MM-DD', income: n, expense: n, feed: n, avgWeight: n, production_labels:[], production_values:[], weekly_labels:[], weekly_values:[] }
    tryAppendLatestPoint(obj);
    if (obj.production_labels && obj.production_values && window.prodChart) {
      window.prodChart.data.labels = obj.production_labels;
      window.prodChart.data.datasets[0].data = toNumberArray(obj.production_values);
      window.prodChart.update();
    }
    if (obj.weekly_labels && obj.weekly_values && window.weeklyChart) {
      window.weeklyChart.data.labels = obj.weekly_labels;
      window.weeklyChart.data.datasets[0].data = toNumberArray(obj.weekly_values);
      window.weeklyChart.update();
    }
    if (obj.total_income !== undefined && obj.total_expense !== undefined && window.perfChart) {
      window.perfChart.data.datasets[0].data = [Number(obj.total_income||0), Number(obj.total_expense||0)];
      window.perfChart.update();
    }
    if (obj.task_counts && window.tasksChart) {
      window.tasksChart.data.datasets[0].data = [obj.task_counts.Pending||0, obj.task_counts['In Progress']||0, obj.task_counts.Completed||0];
      window.tasksChart.update();
    }
  };

  /***** END JS *****/
})();
</script>
{% endblock %}